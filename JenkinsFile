pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'

    HOME = 'C:\\Users\\clp-jenkins' // üëà Required for PM2
  }

  stages {
    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node Environment') {
      steps {
        powershell 'node -v'
        powershell 'npm -v'
      }
    }

    stage('Deploy & Start DEV Server') {
      steps {
        withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {
          powershell """
            # === Prepare Server Directory ===
            if (-Not (Test-Path '${env.DEV_DEPLOY_SERVER_DIR}')) {
              New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_SERVER_DIR}' | Out-Null
            } else {
              Remove-Item '${env.DEV_DEPLOY_SERVER_DIR}\\*' -Recurse -Force
            }
            Copy-Item '${env.CODEBASE_SERVER_DIR}\\*' -Destination '${env.DEV_DEPLOY_SERVER_DIR}' -Recurse -Force

            # === Prepare Client Directory ===
            if (-Not (Test-Path '${env.DEV_DEPLOY_CLIENT_DIR}')) {
              New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_CLIENT_DIR}' | Out-Null
            } else {
              Remove-Item '${env.DEV_DEPLOY_CLIENT_DIR}\\*' -Recurse -Force
            }
            Copy-Item '${env.CODEBASE_CLIENT_DIR}\\*' -Destination '${env.DEV_DEPLOY_CLIENT_DIR}' -Recurse -Force

            # === Inject .env ===
            Copy-Item -Path '${env.DEV_ENV_FILE}' -Destination '${env.DEV_DEPLOY_SERVER_DIR}\\.env' -Force

            # === Ensure PM2 ===
            if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
              Write-Host 'üîß Installing PM2 globally...'
              npm install -g pm2
            }

            # === Start or Restart PM2 Process (Detached) ===
            Set-Location '${env.DEV_DEPLOY_SERVER_DIR}'

            if (pm2 list | Select-String 'clp-dev') {
              Write-Host 'üîÅ Deleting previous clp-dev process...'
              pm2 delete clp-dev
            }

            Write-Host 'üöÄ Starting new clp-dev process (detached)...'
            Start-Process -NoNewWindow -FilePath "pm2.cmd" -ArgumentList 'start server.js --name clp-dev --env development --update-env'

            Start-Sleep -Seconds 3
            pm2 save
          """
        }
      }
    }
  }
}
