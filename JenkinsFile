pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\prd\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\prd\\client'

    HOME = 'C:\\Users\\clp-jenkins'
    PM2_HOME = 'E:\\jenkins_pm2' // âœ… Fixes PM2 for Jenkins user
  }

  stages {

    stage('ğŸ§¹ Clean Old PROD Deployment') {
      steps {
        powershell 'E:\\deploy\\_scripts\\Clean-DeploymentFolders.ps1 -ENVIRONMENT "prd"'
      }
    }

    stage('ğŸ“¥ Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('ğŸ§ª Verify Node Environment') {
      steps {
        powershell 'E:\\deploy\\_scripts\\Verify-NodeEnvironment.ps1'
      }
    }

    stage('ğŸš€ Deploy & Start Server') {
      steps {
        withCredentials([file(credentialsId: 'prd.env', variable: 'PRD_ENV_FILE')]) {
          powershell "E:\\deploy\\_scripts\\Deploy-Server.ps1 -Environment 'prd' -EnvFile '${PRD_ENV_FILE}'"
        }
      }
    }

    stage('ğŸ› ï¸ Build & Start Client') {
      steps {
        powershell 'E:\\deploy\\_scripts\\Deploy-Client.ps1 -Environment "prd"'
      }
    }
  }
}
