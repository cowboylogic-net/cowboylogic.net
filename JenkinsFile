pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'

    HOME = 'C:\\Users\\clp-jenkins' // ðŸ‘ˆ Required for PM2
  }

  stages {
    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node Environment') {
      steps {
        powershell 'node -v'
        powershell 'npm -v'
      }
    }

    stage('Deploy & Start DEV Server') {
	  steps {
		withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {

		  // ðŸŸ© Setup and deployment
		  powershell """
			# === Prepare Directories ===
			if (-Not (Test-Path '${env.DEV_DEPLOY_SERVER_DIR}')) {
			  New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_SERVER_DIR}' | Out-Null
			} else {
			  Remove-Item '${env.DEV_DEPLOY_SERVER_DIR}\\*' -Recurse -Force
			}
			Copy-Item '${env.CODEBASE_SERVER_DIR}\\*' -Destination '${env.DEV_DEPLOY_SERVER_DIR}' -Recurse -Force

			if (-Not (Test-Path '${env.DEV_DEPLOY_CLIENT_DIR}')) {
			  New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_CLIENT_DIR}' | Out-Null
			} else {
			  Remove-Item '${env.DEV_DEPLOY_CLIENT_DIR}\\*' -Recurse -Force
			}
			Copy-Item '${env.CODEBASE_CLIENT_DIR}\\*' -Destination '${env.DEV_DEPLOY_CLIENT_DIR}' -Recurse -Force

			# === Inject .env ===
			Copy-Item -Path '${env.DEV_ENV_FILE}' -Destination '${env.DEV_DEPLOY_SERVER_DIR}\\.env' -Force

			# === Ensure PM2 Installed ===
			if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
			  npm install -g pm2
			}

			# === PM2 Clean Start ===
			Set-Location '${env.DEV_DEPLOY_SERVER_DIR}'
			if (pm2 list | Select-String 'clp-dev') {
			  pm2 delete clp-dev
			}
		  """

		  // ðŸŸ¨ Start PM2 Detached
		  powershell """
			Set-Location '${env.DEV_DEPLOY_SERVER_DIR}'
			Start-Process -NoNewWindow -FilePath "pm2.cmd" -ArgumentList 'start server.js --name clp-dev --env development --update-env'
			Start-Sleep -Seconds 3
			pm2 save
		  """
		}
	  }
	}
  }
}
