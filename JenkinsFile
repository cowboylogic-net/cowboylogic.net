pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'

    HOME = 'C:\\Users\\clp-jenkins'
    PM2_HOME = 'E:\\jenkins_pm2' // âœ… Fixes PM2 for Jenkins user
  }

  stages {

    stage('ğŸ§¹ Clean Old DEV Deployment') {
      steps {
        powershell 'E:\\deploy\\_scripts\\Clean-DeploymentFolders.ps1 -ENVIRONMENT "dev"'
      }
    }

    stage('ğŸ“¥ Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('ğŸ§ª Verify Node Environment') {
      steps {
        powershell 'E:\\deploy\\_scripts\\Verify-NodeEnvironment.ps1'
      }
    }

    stage('ğŸš€ Deploy & Start DEV Server') {
      steps {
        withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {
          bat 'E:\\deploy\\_scripts\\init-dev-folders.bat'
          bat "E:\\deploy\\_scripts\\copy-dev-code.bat ${env.CODEBASE_SERVER_DIR} ${env.CODEBASE_CLIENT_DIR}"
          bat "E:\\deploy\\_scripts\\inject-env.bat %DEV_ENV_FILE%"
          bat "E:\\deploy\\_scripts\\start-pm2-dev.bat"
        }
      }
    }

    stage('ğŸ› ï¸ Build & Start DEV Client') {
      steps {
        bat "E:\\deploy\\_scripts\\start-pm2-client.bat"
      }
    }
  }
}
