pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'
  }

  stages {
    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node Environment') {
      steps {
        powershell 'node -v'
        powershell 'npm -v'
      }
    }

    stage('Check & Install PM2 if Missing') {
      steps {
        powershell """
          if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
            Write-Host 'üîß PM2 not found. Installing globally...'
            npm install -g pm2
          } else {
            Write-Host '‚úÖ PM2 is already installed.'
          }
        """
      }
    }

    stage('Server Code ‚Üí DEV Deploy') {
      steps {
        powershell """
          if (-Not (Test-Path '${env.DEV_DEPLOY_SERVER_DIR}')) {
            New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_SERVER_DIR}' | Out-Null
          } else {
            Remove-Item '${env.DEV_DEPLOY_SERVER_DIR}\\*' -Recurse -Force
          }
          Copy-Item '${env.CODEBASE_SERVER_DIR}\\*' -Destination '${env.DEV_DEPLOY_SERVER_DIR}' -Recurse -Force
        """
      }
    }

    stage('Client Code ‚Üí DEV Deploy') {
      steps {
        powershell """
          if (-Not (Test-Path '${env.DEV_DEPLOY_CLIENT_DIR}')) {
            New-Item -ItemType Directory -Path '${env.DEV_DEPLOY_CLIENT_DIR}' | Out-Null
          } else {
            Remove-Item '${env.DEV_DEPLOY_CLIENT_DIR}\\*' -Recurse -Force
          }
          Copy-Item '${env.CODEBASE_CLIENT_DIR}\\*' -Destination '${env.DEV_DEPLOY_CLIENT_DIR}' -Recurse -Force
        """
      }
    }

    stage('Write .env to DEV Server') {
      steps {
        withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {
          powershell """
            Copy-Item -Path '${env.DEV_ENV_FILE}' -Destination '${env.DEV_DEPLOY_SERVER_DIR}\\.env' -Force
          """
        }
      }
    }

    stage('Start Server with PM2 (DEV)') {
      steps {
        powershell """
          Set-Location '${env.DEV_DEPLOY_SERVER_DIR}'

          if (pm2 list | Select-String 'clp-dev') {
            Write-Host 'üîÅ Restarting existing PM2 process...'
            pm2 restart clp-dev
          } else {
            Write-Host 'üöÄ Starting new PM2 process in DEV mode...'
            pm2 start server.js --name clp-dev --env development
          }

          pm2 save
        """
      }
    }
  }
}
