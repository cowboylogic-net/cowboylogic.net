pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'

    HOME = 'C:\\Users\\clp-jenkins'
    PM2_HOME = 'E:\\jenkins_pm2' // ‚úÖ Fixes PM2 for Jenkins user
  }


  stages {
    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node Environment') {
      steps {
        bat 'node -v'
        bat 'npm -v'
      }
    }

    stage('Deploy & Start DEV Server') {
      steps {
        withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {
          bat 'E:\\deploy\\_scripts\\init-dev-folders.bat'
          bat "E:\\deploy\\_scripts\\copy-dev-code.bat ${env.CODEBASE_SERVER_DIR} ${env.CODEBASE_CLIENT_DIR}"
          bat "E:\\deploy\\_scripts\\inject-env.bat %DEV_ENV_FILE%"
          bat "E:\\deploy\\_scripts\\start-pm2-dev.bat"
        }
      }
    }

    stage('Build & Start DEV Client') {
      steps {
        bat "E:\\deploy\\_scripts\\start-pm2-client.bat"
      }
    }
	
	stage('PM2 Status and Logs') {
	  steps {
		bat '''
		  set PM2_HOME=E:\\jenkins_pm2
		  echo üìã PM2 process list:
		  pm2 list

		  echo.
		  echo üîç PM2 process details for clp-server:
		  pm2 describe clp-server

		  echo.
		  echo üîç PM2 process details for clp-client:
		  pm2 describe clp-client

		  echo.
		  echo üìÑ PM2 logs tail:
		  pm2 logs --lines 10
		'''
	  }
	}
  }
}
