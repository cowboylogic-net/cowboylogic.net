pipeline {
  agent {
    node {
      label 'built-in'
    }
  }

  tools {
    nodejs 'node24'
  }

  environment {
    CODEBASE_SERVER_DIR = 'server'
    CODEBASE_CLIENT_DIR = 'client'

    DEV_DEPLOY_SERVER_DIR = 'E:\\deploy\\dev\\server'
    DEV_DEPLOY_CLIENT_DIR = 'E:\\deploy\\dev\\client'

    HOME = 'C:\\Users\\clp-jenkins' // Required for PM2
  }

  stages {
    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node Environment') {
      steps {
        bat 'node -v'
        bat 'npm -v'
      }
    }

    stage('Deploy & Start DEV Server') {
      steps {
        withCredentials([file(credentialsId: 'dev.env', variable: 'DEV_ENV_FILE')]) {
          bat """
            REM === Prepare Server Directory ===
            IF NOT EXIST "${env.DEV_DEPLOY_SERVER_DIR}" (
              mkdir "${env.DEV_DEPLOY_SERVER_DIR}"
            ) ELSE (
              rmdir /S /Q "${env.DEV_DEPLOY_SERVER_DIR}"
              mkdir "${env.DEV_DEPLOY_SERVER_DIR}"
            )
            xcopy /E /I /Y "${env.CODEBASE_SERVER_DIR}\\*" "${env.DEV_DEPLOY_SERVER_DIR}"

            REM === Prepare Client Directory ===
            IF NOT EXIST "${env.DEV_DEPLOY_CLIENT_DIR}" (
              mkdir "${env.DEV_DEPLOY_CLIENT_DIR}"
            ) ELSE (
              rmdir /S /Q "${env.DEV_DEPLOY_CLIENT_DIR}"
              mkdir "${env.DEV_DEPLOY_CLIENT_DIR}"
            )
            xcopy /E /I /Y "${env.CODEBASE_CLIENT_DIR}\\*" "${env.DEV_DEPLOY_CLIENT_DIR}"

            REM === Inject .env ===
            copy /Y "%DEV_ENV_FILE%" "${env.DEV_DEPLOY_SERVER_DIR}\\.env"

            REM === Ensure PM2 is installed ===
            call npm install -g pm2

            REM === Change to server dir and restart PM2 ===
            pushd "${env.DEV_DEPLOY_SERVER_DIR}"

            pm2 delete clp-dev >nul 2>&1

            echo ðŸš€ Starting new clp-dev process (detached)...
            cmd /c start "" pm2 start server.js --name clp-dev --env development --update-env

            timeout /t 5 /nobreak
            pm2 save

            popd

            echo âœ… Server deployed and started via PM2
          """
        }
      }
    }
  }
}
